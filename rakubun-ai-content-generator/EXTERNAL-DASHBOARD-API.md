# Rakubun External Admin Dashboard - API Documentation

This document outlines the API routes and dashboard features required for the external admin dashboard at `https://app.rakubun.com` to manage WordPress plugin instances.

## Table of Contents

1. [API Overview](#api-overview)
2. [Authentication](#authentication)
3. [API Routes](#api-routes)
4. [Dashboard Features](#dashboard-features)
5. [Database Schema](#database-schema)
6. [Webhooks](#webhooks)
7. [Security Considerations](#security-considerations)
8. [Implementation Timeline](#implementation-timeline)

## API Overview

The external dashboard will provide a RESTful API to manage multiple WordPress plugin installations from a centralized location. Each WordPress site will have a unique instance ID and API token for authentication.

**Base URL**: `https://app.rakubun.com/api/v1`

**Content Type**: `application/json`

**Authentication**: Bearer token + Instance ID header

## Authentication

Each WordPress plugin instance will authenticate using:
- **Bearer Token**: Unique API token assigned during registration
- **Instance ID**: UUID4 generated by the WordPress plugin
- **Site URL**: For verification and identification

### Headers Required
```
Authorization: Bearer {api_token}
Content-Type: application/json
X-Instance-ID: {instance_id}
User-Agent: Rakubun-WordPress-Plugin/{version}
```

## API Routes

### 1. Health Check

**GET** `/health`

Simple health check endpoint.

**Response:**
```json
{
  "status": "ok",
  "timestamp": "2025-11-05T12:00:00Z"
}
```

### 2. Plugin Registration

**POST** `/plugins/register`

Register a new WordPress plugin instance.

**Request Body:**
```json
{
  "instance_id": "uuid4",
  "site_url": "https://example.com",
  "site_title": "Example Site",
  "admin_email": "admin@example.com",
  "wordpress_version": "6.3.2",
  "plugin_version": "1.2.1",
  "php_version": "8.1.0",
  "theme": "Twenty Twenty-Three",
  "timezone": "Asia/Tokyo",
  "language": "ja",
  "post_count": 45,
  "page_count": 12,
  "media_count": 234,
  "article_generations": 15,
  "image_generations": 30,
  "activation_date": "2025-11-05 12:00:00",
  "last_activity": "2025-11-05 12:00:00"
}
```

**Response:**
```json
{
  "success": true,
  "api_token": "generated_api_token",
  "instance_id": "uuid4",
  "status": "registered",
  "message": "Plugin registered successfully"
}
```

### 3. User Credits Management

**GET** `/users/credits`

Get user credit balance.

**Query Parameters:**
- `user_email` (required): User's email address
- `user_id` (required): WordPress user ID
- `site_url` (required): Site URL for context

**Response:**
```json
{
  "success": true,
  "credits": {
    "article_credits": 10,
    "image_credits": 25,
    "rewrite_credits": 5
  },
  "last_updated": "2025-11-05T12:00:00Z"
}
```

**POST** `/users/deduct-credits`

Deduct credits from user account.

**Request Body:**
```json
{
  "user_email": "user@example.com",
  "user_id": 123,
  "site_url": "https://example.com",
  "credit_type": "article|image|rewrite",
  "amount": 1
}
```

**Response:**
```json
{
  "success": true,
  "remaining_credits": {
    "article_credits": 9,
    "image_credits": 25,
    "rewrite_credits": 5
  },
  "transaction_id": "txn_123456"
}
```

### 4. Configuration Management

**GET** `/config/openai`

Get OpenAI API configuration.

**Response:**
```json
{
  "api_key": "sk-...",
  "model_article": "gpt-4",
  "model_image": "dall-e-3",
  "max_tokens": 2000,
  "temperature": 0.7
}
```

**POST** `/config/openai`

Update OpenAI configuration (admin only).

**Request Body:**
```json
{
  "api_key": "sk-...",
  "model_article": "gpt-4",
  "model_image": "dall-e-3",
  "max_tokens": 2000,
  "temperature": 0.7
}
```

### 5. Package Management

**GET** `/packages`

Get available credit packages.

**Response:**
```json
{
  "packages": {
    "articles": [
      {
        "id": "article_starter",
        "name": "Article Starter Pack",
        "credits": 10,
        "price": 750,
        "type": "article",
        "currency": "JPY",
        "description": "Perfect for small blogs"
      },
      {
        "id": "article_pro",
        "name": "Article Pro Pack",
        "credits": 50,
        "price": 3000,
        "type": "article",
        "currency": "JPY",
        "description": "For content creators",
        "popular": true
      }
    ],
    "images": [
      {
        "id": "image_starter",
        "name": "Image Starter Pack",
        "credits": 20,
        "price": 300,
        "type": "image",
        "currency": "JPY",
        "description": "Great for visual content"
      }
    ],
    "rewrites": [
      {
        "id": "rewrite_starter",
        "name": "Rewrite Starter Pack",
        "credits": 50,
        "price": 3000,
        "type": "rewrite",
        "currency": "JPY",
        "discount": "17% off",
        "description": "Optimize existing content"
      }
    ]
  }
}
```

**POST** `/packages`

Create or update packages (admin only).

### 6. Analytics and Usage

**POST** `/analytics/generation`

Log individual content generation.

**Request Body:**
```json
{
  "user_email": "user@example.com",
  "user_id": 123,
  "site_url": "https://example.com",
  "content_type": "article|image|rewrite",
  "prompt": "Generate an article about...",
  "result_length": 1500,
  "credits_used": 1,
  "timestamp": "2025-11-05 12:00:00"
}
```

**POST** `/analytics/usage`

Bulk analytics data from WordPress site.

**Request Body:**
```json
{
  "site_url": "https://example.com",
  "sync_period": {
    "from": "2025-11-04 12:00:00",
    "to": "2025-11-05 12:00:00"
  },
  "articles": [
    {
      "user_id": 123,
      "prompt": "Article about...",
      "content_length": 1500,
      "created_at": "2025-11-05 10:00:00"
    }
  ],
  "images": [
    {
      "user_id": 123,
      "prompt": "Image of...",
      "created_at": "2025-11-05 11:00:00"
    }
  ],
  "total_users": 25,
  "plugin_version": "1.2.1"
}
```

### 7. Instance Management

**GET** `/instances/{instance_id}`

Get instance details.

**PUT** `/instances/{instance_id}`

Update instance information.

**DELETE** `/instances/{instance_id}`

Deactivate instance.

## Dashboard Features

### 1. Multi-Site Management Dashboard

**Main Dashboard:**
- Overview of all registered WordPress sites
- Total usage statistics across all sites
- Revenue and credit usage analytics
- Site health status indicators

**Site List View:**
- Table of all registered sites with:
  - Site name and URL
  - Registration date
  - Last activity
  - Total generations (articles/images)
  - Status (active/inactive)
  - Actions (view details, configure, disable)

### 2. Site Detail Pages

**Site Overview:**
- Site information (WordPress version, theme, plugin version)
- User count and activity
- Content statistics (posts, pages, media)
- Generation history and trends

**User Management:**
- List of users with credit balances
- Credit transaction history
- Individual user analytics
- Ability to add/remove credits manually

**Configuration:**
- OpenAI API settings for this site (or global)
- Package pricing (site-specific or global)
- Feature toggles (enable/disable specific features)

### 3. Global Configuration

**OpenAI Settings:**
- API key management
- Model selection (GPT-4, DALL-E 3, etc.)
- Default parameters (max tokens, temperature)
- Usage monitoring and cost tracking

**Package Management:**
- Create and edit credit packages
- Set pricing (global or site-specific)
- Package analytics (most popular, revenue per package)
- Discount and promotion management

**User & Credit Management:**
- Global credit pool management
- Bulk credit operations
- Credit expiration policies
- Free credit allocation rules

### 4. Analytics & Reporting

**Usage Analytics:**
- Generation trends over time
- Popular content types
- User behavior analysis
- Site performance comparisons

**Financial Reports:**
- Revenue tracking
- Cost analysis (OpenAI usage vs revenue)
- Profit margins
- Subscription and package performance

**Technical Monitoring:**
- API response times
- Error rates and types
- Plugin version distribution
- WordPress version compatibility

### 5. Support & Maintenance

**Site Health Monitoring:**
- Plugin update notifications
- WordPress compatibility alerts
- API connectivity status
- Error log aggregation

**Support Tools:**
- Direct communication with site admins
- Remote configuration changes
- Credit adjustment tools
- Issue resolution tracking

### 6. Admin Tools

**User Management:**
- Admin user accounts for dashboard access
- Role-based permissions
- Activity logs
- Multi-factor authentication

**System Configuration:**
- API rate limiting
- Webhook management
- Backup and recovery
- Security settings

## Database Schema

### Core Tables

**sites**
```sql
CREATE TABLE sites (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    instance_id VARCHAR(36) UNIQUE NOT NULL,
    api_token VARCHAR(255) UNIQUE NOT NULL,
    site_url VARCHAR(255) NOT NULL,
    site_title VARCHAR(255),
    admin_email VARCHAR(255),
    wordpress_version VARCHAR(50),
    plugin_version VARCHAR(50),
    php_version VARCHAR(50),
    theme VARCHAR(255),
    timezone VARCHAR(100),
    language VARCHAR(10),
    status ENUM('active', 'inactive', 'suspended') DEFAULT 'active',
    registered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_activity TIMESTAMP,
    last_sync TIMESTAMP,
    INDEX idx_instance_id (instance_id),
    INDEX idx_api_token (api_token),
    INDEX idx_site_url (site_url)
);
```

**users**
```sql
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    site_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    user_email VARCHAR(255) NOT NULL,
    article_credits INT DEFAULT 0,
    image_credits INT DEFAULT 0,
    rewrite_credits INT DEFAULT 0,
    total_articles_generated INT DEFAULT 0,
    total_images_generated INT DEFAULT 0,
    total_rewrites_generated INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (site_id) REFERENCES sites(id),
    UNIQUE KEY unique_user_site (site_id, user_id),
    INDEX idx_user_email (user_email)
);
```

**packages**
```sql
CREATE TABLE packages (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    package_id VARCHAR(100) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    credit_type ENUM('article', 'image', 'rewrite') NOT NULL,
    credits INT NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'JPY',
    description TEXT,
    is_popular BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**credit_transactions**
```sql
CREATE TABLE credit_transactions (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    site_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    transaction_type ENUM('purchase', 'deduction', 'refund', 'bonus') NOT NULL,
    credit_type ENUM('article', 'image', 'rewrite') NOT NULL,
    amount INT NOT NULL,
    balance_after INT NOT NULL,
    reference_id VARCHAR(255),
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (site_id) REFERENCES sites(id),
    INDEX idx_site_user (site_id, user_id),
    INDEX idx_transaction_type (transaction_type)
);
```

**generation_logs**
```sql
CREATE TABLE generation_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    site_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    content_type ENUM('article', 'image', 'rewrite') NOT NULL,
    prompt TEXT,
    result_length INT,
    credits_used INT DEFAULT 1,
    processing_time DECIMAL(8,3),
    status ENUM('success', 'failed', 'error') DEFAULT 'success',
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (site_id) REFERENCES sites(id),
    INDEX idx_site_date (site_id, created_at),
    INDEX idx_content_type (content_type)
);
```

**openai_config**
```sql
CREATE TABLE openai_config (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    site_id BIGINT NULL, -- NULL for global config
    api_key_encrypted TEXT NOT NULL,
    model_article VARCHAR(50) DEFAULT 'gpt-4',
    model_image VARCHAR(50) DEFAULT 'dall-e-3',
    max_tokens INT DEFAULT 2000,
    temperature DECIMAL(3,2) DEFAULT 0.70,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (site_id) REFERENCES sites(id),
    INDEX idx_site_id (site_id)
);
```

## Webhooks

The dashboard should support webhooks to notify WordPress sites of important events:

### Webhook Events

**config_updated**
- Triggered when OpenAI configuration changes
- WordPress site should refresh cached config

**credits_updated**
- Triggered when user credits are manually adjusted
- WordPress site should clear user credit cache

**plugin_disabled**
- Triggered when admin disables plugin for a site
- WordPress site should disable functionality

**plugin_enabled**
- Triggered when admin re-enables plugin for a site
- WordPress site should restore functionality

**package_updated**
- Triggered when packages are modified
- WordPress site should refresh package cache

### Webhook Payload

```json
{
  "event": "config_updated",
  "site_id": 123,
  "instance_id": "uuid4",
  "timestamp": "2025-11-05T12:00:00Z",
  "data": {
    "config_type": "openai",
    "changes": ["api_key", "model_article"]
  }
}
```

## Security Considerations

### 1. API Security
- Rate limiting (100 requests per minute per site)
- API token rotation capability
- Request signature verification
- IP whitelisting option

### 2. Data Protection
- Encrypt sensitive data (API keys, personal information)
- GDPR compliance for EU users
- Data retention policies
- Secure API key storage

### 3. Access Control
- Role-based admin access
- Multi-factor authentication
- Audit logs for all admin actions
- Site-level permission controls

### 4. WordPress Plugin Security
- Verify webhook signatures
- Validate all API responses
- Secure credential storage
- Regular security updates

## Implementation Timeline

### Phase 1: Core Infrastructure (Week 1-2)
- [ ] Database schema setup
- [ ] Basic API framework
- [ ] Authentication system
- [ ] Plugin registration endpoint

### Phase 2: Credit Management (Week 3-4)
- [ ] User credit tracking
- [ ] Credit deduction API
- [ ] Transaction logging
- [ ] Basic dashboard UI

### Phase 3: Configuration Management (Week 5-6)
- [ ] OpenAI config management
- [ ] Package management
- [ ] Site configuration
- [ ] Webhook system

### Phase 4: Analytics & Reporting (Week 7-8)
- [ ] Usage analytics
- [ ] Generation logging
- [ ] Dashboard reporting
- [ ] Export functionality

### Phase 5: Advanced Features (Week 9-10)
- [ ] Multi-admin support
- [ ] Advanced analytics
- [ ] Monitoring tools
- [ ] Support features

### Phase 6: Testing & Optimization (Week 11-12)
- [ ] Security testing
- [ ] Performance optimization
- [ ] WordPress plugin testing
- [ ] Documentation finalization

## API Testing

### Development Environment
- Test API endpoints with Postman/Insomnia
- Mock WordPress plugin for testing
- Sandbox environment with sample data
- Automated API testing suite

### WordPress Plugin Testing
- Test registration flow
- Verify credit deduction
- Test configuration synchronization
- Validate webhook handling

## Monitoring & Maintenance

### System Monitoring
- API response time monitoring
- Database performance tracking
- Error rate alerts
- Uptime monitoring

### Business Monitoring
- Revenue tracking
- User growth metrics
- Feature usage analytics
- Cost optimization

### Regular Maintenance
- Database optimization
- Security updates
- Performance tuning
- Backup verification

---

This documentation provides a comprehensive blueprint for building the external admin dashboard. The system is designed to be scalable, secure, and user-friendly while providing powerful management capabilities for multiple WordPress plugin installations.